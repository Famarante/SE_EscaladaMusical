<!DOCTYPE html>
<html>
<head>
    <script src="https://code.createjs.com/createjs-2015.11.26.min.js"></script>
    <script>
        var stage, preload, bird, startTime, timerTxt, bubbleSpeech, factor = 1, birdSound, fibonacci = 1;
        
        document.documentElement.style.overflow = 'hidden';  // firefox, chrome
        document.body.scroll = 'no'; // ie only
        
        function handleResize() {
            stage.canvas.width = 1024;
            stage.canvas.height = 768;
            factor = 1;
            if(window.innerWidth < 1024){
                var factorTmp = 1 - (1024 - window.innerWidth)/1024;
                if(factorTmp < factor){
                    factor = factorTmp;
                }
            }
            if(window.innerHeight < 768){
                var factorTmp = 1 - (768 - window.innerHeight)/768;
                if(factorTmp < factor){
                    factor = factorTmp;
                }
            }
            if(window.innerWidth >= 1024 || window.innerHeight >= 768){
                stage.canvas.width = 1024;
                stage.canvas.height = 768;
            }
            stage.canvas.width = 1024*factor;
            stage.canvas.height = 768*factor;
            stage.scaleX = factor;
            stage.scaleY = factor;
            stage.update();
        }
        
        function handleComplete() {
            stage = new createjs.Stage("canvas");
            stage.enableMouseOver();

            timerTxt = new createjs.Text("Tempo: ", "bold 24px Arial", "#000000");
            timerTxt.name = "timerText";
            timerTxt.textAlign = "left";
            timerTxt.textBaseline = "middle";
            timerTxt.x = 855;
            timerTxt.y = 40;

            var spriteSheet = new createjs.SpriteSheet({
                framerate: 30,
                "images": [preload.getResult("bird_sprite")],
                "frames": {"height": 314, "count": 22, "width": 240, "regX": 157, "regY": 120},
                // define two animations, run (loops, 1.5x speed) and jump (returns to run):
                "animations": {
                    "fly": [0, 21, "fly"]
                }
            });
            
            handleResize();
            
            bird = new createjs.Sprite(spriteSheet, "fly");

            window.addEventListener("resize", handleResize);
            
            startMenuLevel();
        }

        function init() {
            var manifest = [
                {id: "c_sound", src: "assets/sounds/c_sound.wav"},
                {id: "csharp_sound", src: "assets/sounds/csharp_sound.wav"},
                {id: "bird_sprite", src: "assets/images/bird_sprite.png"},
                {id: "background", src: "assets/images/background.png"},
                {id: "start_menu_background", src: "assets/images/start_menu_background.png"},
                {id: "selection_level_background", src: "assets/images/selection_level_background.png"},
                {id: "bubble", src: "assets/images/bubble.png"},
                {id: "level1_background", src: "assets/images/level1_background.png"},
                {id: "level1_birds", src: "assets/images/level1_phase1_background.png"},
                {id: "level1_signs", src: "assets/images/level1_phase2_background.png"},
                {id: "level1_houses", src: "assets/images/level1_phase3_background.png"},
                {id: "red_bird", src: "assets/images/red_bird.png"},
                {id: "blue_bird", src: "assets/images/blue_bird.png"}
            ];
            createjs.Sound.registerPlugins([createjs.HTMLAudioPlugin]);

            preload = new createjs.LoadQueue(false);
            preload.addEventListener("complete", handleComplete);
            preload.installPlugin(createjs.Sound);
            preload.loadManifest(manifest);
        }
        
        function handleMouseEvent(evt) {
            var target = evt.target;
            switch(evt.type){
                case "mouseover":
                    if(target.name == "buttonBackground")
                        target.graphics.clear().beginFill("blue").drawRoundRect(0, 0, 256, 87, 20);
                    break;
                case "click":
                        if(target.parent.name == "startButton") {
                            selectionLevel();
                        }
                        else if(target.name == "firstLevel"){
                            firstLevel1();
                        }
                        else if(target.parent.name == "rulesButton"){
                            alert("REGRAS");
                        }
                        else if(target.parent.name == "skipButton" && target.parent.parent.name == "firstlevel1"){
                            firstLevel2();
                        }
                        else if(stage.name = "firstlevel2"){
                            switch(target.name){
                                case "cSharpNoteBtn":
                                    if(fibonacci == 2){
                                        fibonacci = 3;
                                        stage.getChildByName("cSharpBird").getChildByName("bubbleSpeech2").getChildByName("bubbleText").text = "C#";
                                        firstLevel3();
                                    }
                                    else{
                                        fibonacci = 1;
                                        firstLevel1();
                                    }
                                    break;
                                case "fNoteBtn":
                                    firstLevel1();
                                    break;
                                case "gNoteBtn":
                                    firstLevel1();
                                    break;
                                case "dNoteBtn":
                                    firstLevel1();
                                    break;
                                case "fSharpNoteBtn":
                                    firstLevel1();
                                    break;
                                case "cNoteBtn":
                                    if(fibonacci == 1){
                                        fibonacci = 2;
                                    }
                                    else{
                                        fibonacci = 1;
                                        firstLevel1();
                                    }
                                    bubbleSpeech.getChildByName("bubbleText").text = "C";
                                    stage.getChildByName("cSharpBird").visible = true;
                                    break;
                                case "aNoteBtn":
                                    firstLevel1();
                                    break;
                            }
                        }
                    break;
                case "mouseout":
                    if(target.name == "buttonBackground")
                        target.graphics.clear().beginFill("red").drawRoundRect(0, 0, 256, 87, 20);
                    break;
                default:
                    break;
            }
            stage.update();
        }
        function handleTick(event) {
            var currentTime = (new Date()).getTime();

            var time = Math.floor((currentTime-startTime)/1000);
            if(time > 59){
                timerTxt.text = "Tempo: " + Math.floor(time/60) + "m" + time%60 + "s";
            }
            else{
                timerTxt.text = "Tempo: " + time + "s";
            }
            stage.update();
            if(stage.name == "firstlevel1") {
                if (birdSound.playState == createjs.Sound.PLAY_FINISHED && birdSound.src == "assets/sounds/c_sound.wav") {
                    console.log(stage.getChildByName("cSharpBird").getChildByName("bubbleSpeech2"));
                    stage.getChildByName("cSharpBird").getChildByName("bubbleSpeech2").visible = true;
                    bubbleSpeech.visible = false;
                    playSound("csharp_sound");
                }
                else if (birdSound.playState == createjs.Sound.PLAY_FINISHED && birdSound.src == "assets/sounds/csharp_sound.wav") {
                    stage.getChildByName("cSharpBird").getChildByName("bubbleSpeech2").visible = false;
                    bubbleSpeech.visible = true;
                    playSound("c_sound");
                }
            }
        }

        function playSound(target) {
            //Play the sound: play (src, interrupt, delay, offset, loop, volume, pan)
            var random = Math.floor((Math.random() * 4) + 1);
            var ppc = new createjs.PlayPropsConfig().set({interrupt: createjs.Sound.INTERRUPT_ANY, loop: random, volume: 0.1});
            birdSound = createjs.Sound.play(target, ppc);
            if (birdSound == null || birdSound.playState == createjs.Sound.PLAY_FAILED) {
                return;
            }
        }
        function handleLoad(event) {
        }
        function startMenuLevel(){
            stage.name = "startMenuLevel";
            var startMenuBackground = new createjs.Bitmap(preload.getResult("start_menu_background"));
            stage.addChild(startMenuBackground);

            var startBtnBg = new createjs.Shape();
            startBtnBg.name = "buttonBackground";
            startBtnBg.graphics.beginFill("red").drawRoundRect(0, 0, 256, 87, 20);

            var startBtnTxt = new createjs.Text("Jogar!", "bold 24px Arial", "#FFFFFF");
            startBtnTxt.name = "buttonText";
            startBtnTxt.textAlign = "center";
            startBtnTxt.textBaseline = "middle";
            startBtnTxt.x = 150/2;
            startBtnTxt.y = 60/2;

            var startBtn = new createjs.Container();
            startBtn.name = "startButton";
            startBtn.x = 384;
            startBtn.y = 568;
            startBtn.alpha = 0.01;
            startBtn.addChild(startBtnBg, startBtnTxt);

            startBtn.cursor = "pointer";

            stage.addChild(startBtn);

            startBtn.on("mouseover", handleMouseEvent);
            startBtn.on("mouseout", handleMouseEvent);
            startBtn.on("click", handleMouseEvent);

            var rulesBtnBg = new createjs.Shape();
            rulesBtnBg.name = "buttonBackground";
            rulesBtnBg.graphics.beginFill("red").drawRoundRect(0, 0, 256, 87, 20);

            var rulesBtnTxt = new createjs.Text("Regras", "bold 24px Arial", "#FFFFFF");
            rulesBtnTxt.name = "buttonText";
            rulesBtnTxt.textAlign = "center";
            rulesBtnTxt.textBaseline = "middle";
            rulesBtnTxt.x = 150/2;
            rulesBtnTxt.y = 60/2;

            var rulesBtn = new createjs.Container();
            rulesBtn.name = "rulesButton";
            rulesBtn.x = 384;
            rulesBtn.y = 434;
            rulesBtn.alpha = 0.01;
            rulesBtn.addChild(rulesBtnBg, rulesBtnTxt);

            rulesBtn.cursor = "pointer";

            stage.addChild(rulesBtn);

            rulesBtn.on("mouseover", handleMouseEvent);
            rulesBtn.on("mouseout", handleMouseEvent);
            rulesBtn.on("click", handleMouseEvent);
            
            createjs.Ticker.addEventListener("tick", handleTick);

            stage.update();
        }
        function firstLevel1(){
            clearStage();

            var firstLevelBackground = new createjs.Bitmap(preload.getResult("level1_birds"));
            stage.addChild(firstLevelBackground);

            var bubbleSpeechImage = new createjs.Bitmap(preload.getResult("bubble"));
            bubbleSpeechImage.scaleX = 0.03;
            bubbleSpeechImage.scaleY = 0.03;

            var bubbleSpeechTxt = new createjs.Text("C", "bold 34px Arial", "#000000");
            bubbleSpeechTxt.name = "bubbleText";
            bubbleSpeechTxt.textAlign = "center";
            bubbleSpeechTxt.textBaseline = "middle";
            bubbleSpeechTxt.x = 33;
            bubbleSpeechTxt.y = 20;

            bubbleSpeech = new createjs.Container();
            bubbleSpeech.name = "bubbleSpeech";
            bubbleSpeech.addChild(bubbleSpeechImage, bubbleSpeechTxt);
            bubbleSpeech.x = 365;
            bubbleSpeech.y = 420;
            stage.addChild(bubbleSpeech);

            stage.name = "firstlevel1";
            createjs.Ticker.addEventListener("tick", handleTick);
            startTime = (new Date()).getTime();
            //stage.addChild(timerTxt);
            playSound("c_sound");

            var bubbleSpeechImage2 = new createjs.Bitmap(preload.getResult("bubble"));
            bubbleSpeechImage2.scaleX = -0.03;
            bubbleSpeechImage2.scaleY = 0.03;

            var bubbleSpeechTxt2 = new createjs.Text("C#", "bold 34px Arial", "#000000");
            bubbleSpeechTxt2.name = "bubbleText";
            bubbleSpeechTxt2.textAlign = "center";
            bubbleSpeechTxt2.textBaseline = "middle";
            bubbleSpeechTxt2.x = -33;
            bubbleSpeechTxt2.y = 20;

            var bubbleSpeech2 = new createjs.Container();
            bubbleSpeech2.name = "bubbleSpeech2";
            bubbleSpeech2.addChild(bubbleSpeechImage2, bubbleSpeechTxt2);
            bubbleSpeech2.x = 732;
            bubbleSpeech2.y = 418;
            bubbleSpeech2.visible = false;
            var blueBird = new createjs.Bitmap(preload.getResult("blue_bird"));
            blueBird.x = 800;
            blueBird.y = 450;
            blueBird.scaleX = -0.1;
            blueBird.scaleY = 0.1;

            var cSharpBird = new createjs.Container();
            cSharpBird.name = "cSharpBird";
            cSharpBird.addChild(blueBird, bubbleSpeech2);
            stage.addChild(cSharpBird);

            var skipBtnBg = new createjs.Shape();
            skipBtnBg.name = "buttonBackground";
            skipBtnBg.graphics.beginFill("red").drawRoundRect(0, 0, 256, 87, 20);

            var skipBtnTxt = new createjs.Text("Passar", "bold 48px Arial", "#FFFFFF");
            skipBtnTxt.name = "buttonText";
            skipBtnTxt.textAlign = "center";
            skipBtnTxt.textBaseline = "middle";
            skipBtnTxt.x = 256/2;
            skipBtnTxt.y = 87/2;

            var skipBtn = new createjs.Container();
            skipBtn.name = "skipButton";
            skipBtn.x = 740;
            skipBtn.y = 650;
            skipBtn.addChild(skipBtnBg, skipBtnTxt);
            
            skipBtn.on("click", handleMouseEvent);

            skipBtn.cursor = "pointer";

            stage.addChild(skipBtn);
            stage.update();
        }
        function addSignButtons(){
            var cSharpNoteBtn = new createjs.Shape();
            cSharpNoteBtn.name = "cSharpNoteBtn";
            cSharpNoteBtn.graphics.beginFill("red").drawRect(297, 500, 143, 25);
            cSharpNoteBtn.alpha = 0.01;
            cSharpNoteBtn.rotation = -8;
            cSharpNoteBtn.cursor = "pointer";

            cSharpNoteBtn.on("click", handleMouseEvent);

            var fNoteBtn = new createjs.Shape();
            fNoteBtn.name = "fNoteBtn";
            fNoteBtn.graphics.beginFill("red").drawRect(225, 530, 143, 25);
            fNoteBtn.alpha = 0.01;
            fNoteBtn.rotation = -8;
            fNoteBtn.cursor = "pointer";

            fNoteBtn.on("click", handleMouseEvent);

            var gNoteBtn = new createjs.Shape();
            gNoteBtn.name = "gNoteBtn";
            gNoteBtn.graphics.beginFill("red").drawRect(225, 560, 143, 25);
            gNoteBtn.alpha = 0.01;
            gNoteBtn.rotation = -8;
            gNoteBtn.cursor = "pointer";

            gNoteBtn.on("click", handleMouseEvent);

            var dNoteBtn = new createjs.Shape();
            dNoteBtn.name = "dNoteBtn";
            dNoteBtn.graphics.beginFill("red").drawRect(345, 555, 143, 25);
            dNoteBtn.alpha = 0.01;
            dNoteBtn.rotation = -3;
            dNoteBtn.cursor = "pointer";

            dNoteBtn.on("click", handleMouseEvent);

            var fSharpNoteBtn = new createjs.Shape();
            fSharpNoteBtn.name = "fSharpNoteBtn";
            fSharpNoteBtn.graphics.beginFill("red").drawRect(295, 620, 143, 25);
            fSharpNoteBtn.alpha = 0.01;
            fSharpNoteBtn.rotation = -8;
            fSharpNoteBtn.cursor = "pointer";

            fSharpNoteBtn.on("click", handleMouseEvent);

            var cNoteBtn = new createjs.Shape();
            cNoteBtn.name = "cNoteBtn";
            cNoteBtn.graphics.beginFill("red").drawRect(150, 680, 143, 25);
            cNoteBtn.alpha = 0.01;
            cNoteBtn.rotation = -14;
            cNoteBtn.cursor = "pointer";

            cNoteBtn.on("click", handleMouseEvent);

            var aNoteBtn = new createjs.Shape();
            aNoteBtn.name = "aNoteBtn";
            aNoteBtn.graphics.beginFill("red").drawRect(295, 680, 143, 25);
            aNoteBtn.alpha = 0.01;
            aNoteBtn.rotation = -8;
            aNoteBtn.cursor = "pointer";

            aNoteBtn.on("click", handleMouseEvent);

            stage.addChild(cSharpNoteBtn, fNoteBtn, gNoteBtn, dNoteBtn, fSharpNoteBtn, cNoteBtn, aNoteBtn);
        }

        function firstLevel2(){
            clearStage();
            var firstLevel2Background = new createjs.Bitmap(preload.getResult("level1_signs"));
            stage.addChild(firstLevel2Background);

            var bubbleSpeechImage = new createjs.Bitmap(preload.getResult("bubble"));
            bubbleSpeechImage.scaleX = 0.03;
            bubbleSpeechImage.scaleY = 0.03;

            var bubbleSpeechTxt = new createjs.Text("?", "bold 34px Arial", "#000000");
            bubbleSpeechTxt.name = "bubbleText";
            bubbleSpeechTxt.textAlign = "center";
            bubbleSpeechTxt.textBaseline = "middle";
            bubbleSpeechTxt.x = 33;
            bubbleSpeechTxt.y = 20;

            bubbleSpeech = new createjs.Container();
            bubbleSpeech.addChild(bubbleSpeechImage, bubbleSpeechTxt);
            bubbleSpeech.x = 83;
            bubbleSpeech.y = 350;
            stage.addChild(bubbleSpeech);

            //create invisible buttons for signs
            addSignButtons();

            var bubbleSpeechImage2 = new createjs.Bitmap(preload.getResult("bubble"));
            bubbleSpeechImage2.scaleX = -0.03;
            bubbleSpeechImage2.scaleY = 0.03;

            var bubbleSpeechTxt2 = new createjs.Text("?", "bold 34px Arial", "#000000");
            bubbleSpeechTxt2.name = "bubbleText";
            bubbleSpeechTxt2.textAlign = "center";
            bubbleSpeechTxt2.textBaseline = "middle";
            bubbleSpeechTxt2.x = -33;
            bubbleSpeechTxt2.y = 20;

            var bubbleSpeech2 = new createjs.Container();
            bubbleSpeech2.name = "bubbleSpeech2";
            bubbleSpeech2.addChild(bubbleSpeechImage2, bubbleSpeechTxt2);
            bubbleSpeech2.x = 732;
            bubbleSpeech2.y = 418;
            var blueBird = new createjs.Bitmap(preload.getResult("blue_bird"));
            blueBird.x = 800;
            blueBird.y = 450;
            blueBird.scaleX = -0.1;
            blueBird.scaleY = 0.1;

            var cSharpBird = new createjs.Container();
            cSharpBird.name = "cSharpBird";
            cSharpBird.addChild(blueBird, bubbleSpeech2);
            cSharpBird.visible = false;
            stage.addChild(cSharpBird);

            stage.name = "firstlevel2";
            createjs.Ticker.addEventListener("tick", handleTick);
            startTime = (new Date()).getTime();
            stage.addChild(timerTxt);

            stage.update();
        }
        function firstLevel3(){
            clearStage();
            var firstLevel3Background = new createjs.Bitmap(preload.getResult("level1_houses"));
            stage.addChild(firstLevel3Background);

            stage.update();
        }

        function selectionLevel(){
            clearStage();

            stage.name = "selectionLevel";
            var selectionLevelBackground = new createjs.Bitmap(preload.getResult("selection_level_background"));
            stage.addChild(selectionLevelBackground);

            var firstLevel = new createjs.Shape();
            firstLevel.graphics.beginFill("red").drawRoundRect(0, 0, 130, 35, 10);
            firstLevel.x = 216;
            firstLevel.y = 707;
            firstLevel.alpha = 0.01;
            firstLevel.cursor = "pointer";
            firstLevel.name = "firstLevel";
            firstLevel.on("mouseover", handleMouseEvent);
            firstLevel.on("mouseout", handleMouseEvent);
            firstLevel.on("click", handleMouseEvent);
            stage.addChild(firstLevel);

            stage.update();
        }
        function clearStage(){
            for(var i = 0; i < stage.numChildren; i++){
                stage.removeChildAt(i);
                stage.update();
                i--;
            }
            if(birdSound != null){
                birdSound.stop();
            }
        }
    </script>
</head>
<body onload="init();">
<div id="content">
<canvas id="canvas" width="1024" height="768"></canvas>
</div>
</body>
</html>
